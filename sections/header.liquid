{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 250,
      "step": 10,
      "default": 100,
      "unit": "px",
      "label": "Custom Logo Width"
    },
    {
      "type": "link_list",
      "id": "menu",
      "default": "main-menu",
      "label": "Main Menu"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#000000"
    }
  ],
  "blocks": [
    {
      "type": "mega_menu",
      "name": "Mega Menu",
      "settings": [
        {
          "type": "text",
          "id": "trigger_label",
          "label": "Menu Link Title",
          "info": "The exact name of the menu link to attach this mega menu to."
        },
        {
            "type": "link_list",
            "id": "menu_submenu",
            "label": "Side Menu",
            "info": "The Level 2 menu to display on the left side."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Header"
    }
  ]
}
{% endschema %}

<header class="relative w-full z-40 border-b border-gray-200" style="background-color: {{ section.settings.bg_color }}; color: {{ section.settings.text_color }};">
  <div class="container mx-auto px-4 md:px-8 h-20 flex items-center justify-between">
    
    <!-- Logo -->
    <a href="{{ routes.root_url }}" class="flex-shrink-0 block">
      {% if section.settings.logo %}
        {{ section.settings.logo | image_url: width: section.settings.logo_width | image_tag: class: 'object-contain', loading: 'eager', height: 'auto' }}
      {% else %}
        <span class="text-xl font-bold tracking-tight">{{ shop.name }}</span>
      {% endif %}
    </a>

    <!-- Desktop Navigation -->
    <nav class="hidden lg:flex gap-8 h-full items-center">
      {% for link in section.settings.menu.links %}
        
        {% assign mega_menu_block = nil %}
        {% for block in section.blocks %}
          {% if block.settings.trigger_label == link.title %}
            {% assign mega_menu_block = block %}
            {% break %}
          {% endif %}
        {% endfor %}

        <div class="group h-full flex items-center cursor-pointer">
          <a href="{{ link.url }}" class="flex items-center gap-1 text-sm font-medium hover:opacity-75 transition-opacity h-full relative">
            {{ link.title }}
            {% if mega_menu_block or link.links.size > 0 %}
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            {% endif %}
          </a>

          <!-- Mega Menu Dropdown -->
          {% if mega_menu_block %}
            <div class="absolute left-0 top-full w-full bg-white shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 border-t border-gray-100 transform origin-top z-50">
               <div class="container mx-auto flex min-h-[400px]">
                  
                  <!-- Left Sidebar (Level 2 Links) -->
                  {% assign side_menu = mega_menu_block.settings.menu_submenu %}
                  <div class="w-1/4 py-8 px-6 bg-gray-50 border-r border-gray-100 flex flex-col gap-2">
                     <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-2">{{ mega_menu_block.settings.trigger_label }} Categories</h3>
                     {% if side_menu.links.size > 0 %}
                        {% for child_link in side_menu.links %}
                           <div class="group/side-item relative">
                              <a href="{{ child_link.url }}" class="flex items-center justify-between px-3 py-2 text-gray-700 hover:bg-white hover:text-blue-600 hover:shadow-sm rounded-md transition-all text-sm font-medium">
                                 {{ child_link.title }}
                                 {% if child_link.links.size > 0 %}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-0 group-hover/side-item:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                 {% endif %}
                              </a>
                              
                              <!-- Right Content Area (Level 3 Links - "Stretches out") -->
                              {% if child_link.links.size > 0 %}
                                 <div class="absolute left-full top-0 w-[300%] h-full min-h-[400px] -ml-[1px] bg-white p-8 opacity-0 invisible group-hover/side-item:opacity-100 group-hover/side-item:visible transition-all duration-200 z-10 hidden lg:block" style="top: -2rem; padding-top: 2rem; pointer-events: none;">
                                    
                                     <!-- Hack to allow hover bridge -->
                                     <div class="absolute left-0 top-0 w-4 h-full" style="pointer-events: auto;"></div>

                                     <div class="grid grid-cols-3 gap-8" style="pointer-events: auto;">
                                        {% for grandchild_link in child_link.links %}
                                           <div class="flex flex-col gap-2">
                                              <!-- Collection Image Placeholder if easy to get or just title -->
                                              <a href="{{ grandchild_link.url }}" class="group/collection block">
                                                 <div class="aspect-video bg-gray-100 rounded-md mb-2 overflow-hidden relative">
                                                    <!-- Ideally we'd show collection image here if we had access to object, but link object doesn't always carry it easily without deeper liquid lookups or metaobjects. For now, styled placeholder. -->
                                                    <div class="w-full h-full bg-gray-200 group-hover/collection:bg-gray-300 transition-colors flex items-center justify-center text-gray-400">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                    </div>
                                                 </div>
                                                 <span class="text-sm font-medium text-gray-800 group-hover/collection:text-blue-600 transition-colors">{{ grandchild_link.title }}</span>
                                              </a>
                                           </div>
                                        {% endfor %}
                                     </div>
                                 </div>
                              {% endif %}
                           </div>
                        {% endfor %}
                     {% else %}
                        <p class="text-gray-400 text-sm p-4">Assign a navigation menu to this block.</p>
                     {% endif %}
                  </div>

                  <!-- Default Right Content (Promotional or Empty State) -->
                  <div class="w-3/4 p-8 relative -z-0">
                     <div class="h-full rounded-2xl bg-gray-50 border border-dashed border-gray-200 flex flex-col items-center justify-center text-center p-8">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Explore {{ mega_menu_block.settings.trigger_label }}</h4>
                        <p class="text-gray-500 max-w-md">Hover over the categories on the left to discover our wide range of products.</p>
                     </div>
                  </div>
               </div>
            </div>

          <!-- Fallback Simple Dropdown (if no Mega Menu Block but has children) -->
          {% elsif link.links.size > 0 %}
            <div class="absolute left-0 top-full w-48 bg-white shadow-lg rounded-b-lg py-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 border-t border-gray-100 z-50">
              {% for child in link.links %}
                <a href="{{ child.url }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-blue-600">
                  {{ child.title }}
                </a>
              {% endfor %}
            </div>
          {% endif %}

        </div>
      {% endfor %}
    </nav>

    <!-- Icons / Actions -->
    <div class="flex items-center gap-4">
      <!-- Search (Simplified for now) -->
      <a href="{{ routes.search_url }}" class="text-gray-600 hover:text-gray-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </a>

      <!-- User Account -->
      {% if shop.customer_accounts_enabled %}
        <a href="{{ routes.account_url }}" class="text-gray-600 hover:text-gray-900">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
           </svg>
        </a>
      {% endif %}

      <!-- Cart -->
      <a href="{{ routes.cart_url }}" class="relative text-gray-600 hover:text-gray-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
        {% if cart.item_count > 0 %}
          <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center">
            {{ cart.item_count }}
          </span>
        {% endif %}
      </a>
      
      <!-- Mobile Menu Button (Hamburger) - Basic functionality placeholder -->
      <button class="lg:hidden text-gray-600" aria-label="Menu" onclick="document.querySelector('#mobile-menu-drawer').classList.remove('translate-x-full')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

    </div>
  </div>
  
  <!-- Mobile Drawer Placeholder (To be fully implemented if requested, keep simple for now) -->
  <div id="mobile-menu-drawer" class="fixed inset-0 z-50 bg-white transform translate-x-full transition-transform duration-300 lg:hidden overflow-y-auto">
     <div class="p-4 flex justify-between items-center border-b">
        <span class="font-bold text-lg">Menu</span>
        <button onclick="document.querySelector('#mobile-menu-drawer').classList.add('translate-x-full')">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg>
        </button>
     </div>
     <div class="p-4">
        {% for link in section.settings.menu.links %}
           <div class="py-3 border-b border-gray-100">
              <a href="{{ link.url }}" class="block text-lg font-medium">{{ link.title }}</a>
              {% if link.links.size > 0 %}
                 <div class="pl-4 mt-2 border-l-2 border-gray-100">
                    {% for child in link.links %}
                       <a href="{{ child.url }}" class="block py-1 text-gray-600">{{ child.title }}</a>
                    {% endfor %}
                 </div>
              {% endif %}
           </div>
        {% endfor %}
     </div>
  </div>

</header>
